name: Sync All Branches with Main

on:
  workflow_dispatch:  # Allows manual trigger from GitHub Actions tab
    inputs:
      dry_run:
        description: 'Dry run (do not push changes)'
        required: false
        type: boolean
        default: false

permissions:
  contents: write

jobs:
  sync-branches:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Fetch all history for all branches
          token: ${{ secrets.GITHUB_TOKEN }}
      
      - name: Configure Git
        run: |
          git config user.name "GitHub Actions Bot"
          git config user.email "actions@github.com"
      
      - name: Fetch all branches
        run: |
          git fetch origin
          git fetch --all
      
      - name: Sync branches with main
        env:
          DRY_RUN: ${{ inputs.dry_run }}
        run: |
          # List of branches to sync
          BRANCHES=(
            "copilot/review-software-health"
            "eslint-fixes-clean"
            "qoder/adaptive-client-questionnaire-tool-LR22kj"
            "qoder/quiz-build-deployment-eUsiDf"
            "qoder/quiz-builder-kBVnJv"
            "claude/repository-analysis-4puQN"
          )
          
          echo "========================================="
          echo "Branch Synchronization Workflow"
          echo "========================================="
          echo ""
          echo "Dry run mode: $DRY_RUN"
          echo "Branches to sync: ${#BRANCHES[@]}"
          echo ""
          
          SUCCESSFUL_SYNCS=()
          FAILED_SYNCS=()
          ALREADY_SYNCED=()
          
          for branch in "${BRANCHES[@]}"; do
            echo "========================================="
            echo "Processing: $branch"
            echo "========================================="
            
            # Check if remote branch exists
            if ! git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "âš ï¸  Branch does not exist on remote, skipping"
              FAILED_SYNCS+=("$branch (not found)")
              echo ""
              continue
            fi
            
            # Fetch the branch
            git fetch origin "$branch"
            
            # Check if branch already contains all of main
            if git merge-base --is-ancestor main "origin/$branch" 2>/dev/null; then
              echo "âœ“ Branch already contains all commits from main"
              ALREADY_SYNCED+=("$branch")
              echo ""
              continue
            fi
            
            # Checkout the branch
            if ! git checkout -B "$branch" "origin/$branch"; then
              echo "âœ— Failed to checkout branch"
              FAILED_SYNCS+=("$branch (checkout failed)")
              echo ""
              continue
            fi
            
            # Attempt to merge main
            echo "Merging main into $branch..."
            if git merge main --no-edit --allow-unrelated-histories -X ours; then
              echo "âœ“ Merge successful"
              
              # Verify the merge
              if git merge-base --is-ancestor main HEAD; then
                echo "âœ“ Verified: branch now contains all commits from main"
                
                # Push unless in dry run mode
                if [ "$DRY_RUN" = "true" ]; then
                  echo "ðŸ” Dry run mode - not pushing changes"
                  SUCCESSFUL_SYNCS+=("$branch (dry run)")
                else
                  echo "Pushing to origin..."
                  if git push origin "$branch"; then
                    echo "âœ“ Successfully pushed"
                    SUCCESSFUL_SYNCS+=("$branch")
                  else
                    echo "âœ— Push failed"
                    FAILED_SYNCS+=("$branch (push failed)")
                  fi
                fi
              else
                echo "âœ— Merge verification failed"
                FAILED_SYNCS+=("$branch (verification failed)")
              fi
            else
              echo "âœ— Merge failed"
              git merge --abort 2>/dev/null || true
              FAILED_SYNCS+=("$branch (merge failed)")
            fi
            
            echo ""
          done
          
          # Return to main
          git checkout main
          
          # Print summary
          echo ""
          echo "========================================="
          echo "Synchronization Summary"
          echo "========================================="
          echo ""
          
          if [ ${#ALREADY_SYNCED[@]} -gt 0 ]; then
            echo "Already synced (${#ALREADY_SYNCED[@]}):"
            printf '%s\n' "${ALREADY_SYNCED[@]}" | sed 's/^/  âœ“ /'
            echo ""
          fi
          
          if [ ${#SUCCESSFUL_SYNCS[@]} -gt 0 ]; then
            echo "Successfully synced (${#SUCCESSFUL_SYNCS[@]}):"
            printf '%s\n' "${SUCCESSFUL_SYNCS[@]}" | sed 's/^/  âœ“ /'
            echo ""
          fi
          
          if [ ${#FAILED_SYNCS[@]} -gt 0 ]; then
            echo "Failed to sync (${#FAILED_SYNCS[@]}):"
            printf '%s\n' "${FAILED_SYNCS[@]}" | sed 's/^/  âœ— /'
            echo ""
            exit 1
          fi
          
          echo "Total: ${#BRANCHES[@]} branches"
          echo "Already synced: ${#ALREADY_SYNCED[@]}"
          echo "Newly synced: ${#SUCCESSFUL_SYNCS[@]}"
          echo "Failed: ${#FAILED_SYNCS[@]}"
          echo ""
          
          if [ ${#FAILED_SYNCS[@]} -eq 0 ]; then
            echo "âœ“ All branches are now synced with main! ðŸŽ‰"
          fi
